<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Advanced Harmonic Theremin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
    <style>
        body { margin: 0; overflow: hidden; text-align: center; font-family: Arial, sans-serif; color: white; }
        canvas { display: block; }
        #info { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; }
    </style>
</head>
<body>
    <div id="info">🎵 Advanced Harmonic Theremin 🎵</div>
    <script>
        let video;
        let detector;
        let oscs = [];
        let isStarted = false;
        let scale = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88]; // Cメジャースケール
        let targetFreqs = [];
        let currentFreqs = [];
        let movementSpeed = 0;
        let prevX = 0, prevY = 0, prevZ = 0;
        let reverb, delay, filter, distortion;
        let randomChordChangeTime = 0;

        async function setup() {
            createCanvas(windowWidth, windowHeight);
            
            video = createCapture(VIDEO);
            video.size(windowWidth, windowHeight);
            video.hide();

            for (let i = 0; i < 5; i++) {
                let osc = new p5.Oscillator('sine');
                osc.disconnect();
                oscs.push(osc);
                targetFreqs.push(261.63);
                currentFreqs.push(261.63);
            }

            reverb = new p5.Reverb();
            delay = new p5.Delay();
            filter = new p5.Filter('lowpass');
            distortion = new p5.Distortion(0.1);

            await initHandPoseDetection();
            randomChordChangeTime = millis();
        }

        async function initHandPoseDetection() {
            detector = await handPoseDetection.createDetector(
                handPoseDetection.SupportedModels.MediaPipeHands,
                { runtime: 'tfjs', modelType: 'full', maxHands: 2 }
            );
        }

        async function detectHands() {
            const hands = await detector.estimateHands(video.elt);
            let rightHand = hands.find(h => h.handedness === 'Right');
            let leftHand = hands.find(h => h.handedness === 'Left');

            if (rightHand) {
                let x = rightHand.keypoints[0].x;
                let y = rightHand.keypoints[0].y;
                let z = rightHand.keypoints[0].z;

                let freqIndex = floor(map(y, 1, height, 0, scale.length));
                targetFreqs[0] = scale[constrain(freqIndex, 0, scale.length - 1)];

                let pan = map(x, 0, width, -1, 1);
                for (let osc of oscs) osc.pan(pan);

                let waveform = (z < -30) ? 'sawtooth' : 'sine';
                for (let osc of oscs) osc.setType(waveform);
            }

            if (leftHand) {
                let x = leftHand.keypoints[0].x;
                let y = leftHand.keypoints[0].y;
                let z = leftHand.keypoints[0].z;

                let delayTime = map(x, 0, width, 0, 0.5);
                delay.delayTime(delayTime);

                let filterFreq = map(y, 0, height, 100, 2000);
                filter.freq(filterFreq);

                let distortionAmount = map(z, -50, 50, 0, 0.5);
                distortion.amount(constrain(distortionAmount, 0, 1));
            }
        }

        function draw() {
            background(0);
            image(video, 0, 0, width, height);

            if (!isStarted) {
                fill(255, 0, 0);
                textSize(32);
                textAlign(CENTER, CENTER);
                text("画面をクリックしてください", width / 2, height / 2);
                return;
            }

            detectHands();

            for (let i = 0; i < oscs.length; i++) {
                currentFreqs[i] = lerp(currentFreqs[i], targetFreqs[i], 0.1);
                oscs[i].freq(currentFreqs[i]);
                oscs[i].amp(0.3 / (i + 1));
            }

            if (millis() - randomChordChangeTime > 20000) {
                for (let i = 0; i < oscs.length; i++) {
                    targetFreqs[i] = scale[floor(random(0, scale.length))];
                }
                randomChordChangeTime = millis();
            }
        }

        function mousePressed() {
            if (!isStarted) {
                userStartAudio();
                for (let osc of oscs) {
                    osc.start();
                    osc.connect(filter);
                    filter.connect(delay);
                    delay.connect(reverb);
                    reverb.connect(distortion);
                }
                isStarted = true;
            }
        }
    </script>
</body>
</html>
